PROJECT(FreeImage)

# Determine Platform
IF(MSVC AND CMAKE_CL_64)
	SET(X64 1)
ELSEIF(CMAKE_SIZEOF_VOID_P MATCHES 8)
	SET(X64 1)
ENDIF()
IF(NOT MSVC AND X64)
	SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fPIC")
	SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC")
ENDIF()

# Project directories
FIND_PATH(PROJECT_DIR FreeImage.h PATHS ../src/)
SET(3RDPARTY_DIR ${PROJECT_DIR}/../3rdparty)
SET(PLUGIN_DIR ${PROJECT_DIR}/../plugin)

# FreeImage core
FILE(GLOB SOURCE_FILES ${PROJECT_DIR}/FreeImage/*.cpp ${PROJECT_DIR}/FreeImageToolkit/*.cpp)

SOURCE_GROUP("Source Files" FILES ${SOURCE_FILES})

ADD_DEFINITIONS(-DFREEIMAGE_EXPORTS)
ADD_LIBRARY(freeimage SHARED ${SOURCE_FILES})

IF(MSVC)
	ADD_DEFINITIONS(-D_SCL_SECURE_NO_WARNINGS -D_CRT_SECURE_NO_DEPRECATE)
	OPTION(FISHELLEXT "Build Sentire Context Menu Image Thumbnailer" OFF)
	IF(NOT X64)
		OPTION(SUSIE_PLUGIN "Build Susie plugin" OFF)
	ENDIF()
	# currently cmake doesn't support lto for msvc
	SET(CMAKE_C_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /Ob2 /GL")
	SET(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /Ob2 /GL")
	SET(CMAKE_SHARED_LINKER_FLAGS_RELEASE "${CMAKE_SHARED_LINKER_FLAGS_RELEASE} /LTCG /INCREMENTAL:NO /OPT:REF")
	SET(CMAKE_EXE_LINKER_FLAGS_RELEASE "${CMAKE_SHARED_LINKER_FLAGS_RELEASE} /LTCG /INCREMENTAL:NO /OPT:REF")
ELSE()
	SET(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)
	ADD_DEFINITIONS(-D__ANSI__)
ENDIF()
OPTION(QT_PLUGIN "Build QT plugin" OFF)
OPTION(CONV_TEST "Build a simple convert test program" OFF)

ADD_SUBDIRECTORY(plugin)
ADD_SUBDIRECTORY(libjxr)
ADD_SUBDIRECTORY(libpng)
ADD_SUBDIRECTORY(libtiff)
ADD_SUBDIRECTORY(libwebp)
ADD_SUBDIRECTORY(mozjpeg)
ADD_SUBDIRECTORY(zlib)

ADD_DEPENDENCIES(freeimage libjxr libpng libtiff libwebp mozjpeg zlib)
TARGET_LINK_LIBRARIES(freeimage libjxr libpng libtiff libwebp mozjpeg zlib)

INCLUDE_DIRECTORIES(
	${PROJECT_DIR}
	${3RDPARTY_DIR}/libjxr/common/include
	${3RDPARTY_DIR}/libjxr/image/sys
	${3RDPARTY_DIR}/libjxr/image/x86
	${3RDPARTY_DIR}/libjxr/jxrgluelib
	${3RDPARTY_DIR}/libpng
	${3RDPARTY_DIR}/libtiff/libtiff
	${3RDPARTY_DIR}/libwebp/src
	${3RDPARTY_DIR}/mozjpeg
	${3RDPARTY_DIR}/zlib
	${CMAKE_BINARY_DIR}/mozjpeg
	${CMAKE_BINARY_DIR}/libpng
	${CMAKE_BINARY_DIR}/libtiff
	${CMAKE_BINARY_DIR}/zlib
)

IF(MSVC AND NOT X64)
	SET(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} /SAFESEH:NO")
ENDIF()

IF(WIN32)
	SET_TARGET_PROPERTIES(freeimage PROPERTIES OUTPUT_NAME "FreeImage")
	SET_TARGET_PROPERTIES(freeimage PROPERTIES PREFIX "")
ELSE()
	INCLUDE_DIRECTORIES(${3RDPARTY_DIR}/libjxr/common)
ENDIF()

INSTALL(TARGETS freeimage
	RUNTIME DESTINATION bin}
	LIBRARY DESTINATION lib}
)

INSTALL(FILES
	${PROJECT_DIR}/FreeImage.h
	DESTINATION include
)
